'use strict';Object.defineProperty(exports,"__esModule",{value:true});exports.default=void 0;var _HiddenSheet=require("./HiddenSheet");class QueryBuilder{constructor(options,spreadsheet,sheet){this.spreadsheet=spreadsheet;this.sheet=sheet;this.options=options;this.select_clause="";this.where_clause="";this.rawQuery=""}select(){for(var i=0;i<arguments.length;i++){this.select_clause+=this.getColId(arguments[i])+","}return this}where(col_name,cmp,value,raw){if(typeof value==="undefined"){value=cmp;cmp="="}this._append_where(col_name,cmp,value,"AND",raw);return this}orWhere(col_name,cmp,value,raw){if(typeof value==="undefined"){value=cmp;cmp="="}this._append_where(col_name,cmp,value,"OR",raw);return this}_append_where(col_name,cmp,value,combine,raw){if(this.where_clause.length>0){this.where_clause+=" "+combine+" "}this.where_clause+=this.getColId(col_name)+" "+(raw?raw:cmp+make_value(value))}getColId(colName){return this.options.column_names.getColLabel(colName)}getSelectClause(){if(!this.select_clause||this.select_clause.length<=0){return"SELECT *"}this.select_clause=this.select_clause.replace(/[\,\s]+$/,"");return"SELECT "+this.select_clause}getWhereClause(){if(!this.where_clause)return"";return"WHERE "+this.where_clause}getQuery(){return this.getSelectClause()+" "+this.getWhereClause()}runQuery(numRows){var qry=this.rawQuery?"\"".concat(this.rawQuery,"\""):JSON.stringify(this.getQuery());var hidden_sheet=(0,_HiddenSheet.createHiddenSheet)(this.spreadsheet,this.sheet.getName()+"_query_sheet");var last_col_label=this.options.column_names.getLastColLabel();var colref="'"+this.sheet.getName()+"'!"+"A"+":"+last_col_label;var formula="QUERY(".concat(colref,",").concat(qry,", 1)");var rows=hidden_sheet.runQuery(formula,numRows||this.sheet.getLastRow()-1);return rows}toJSON(numRecords){return this.options.column_names.makeJson(this.runQuery(numRecords))}raw(query){this.rawQuery=query;return this}};function make_value(val){if(typeof val==="string"||val instanceof String){return"'"+val+"'"}return val}function getLastRow(range){var rowNum=0;var blank=false;for(var row=0;row<range.length;row++){if(range[row][0]===""&&!blank){rowNum=row;blank=true}else if(range[row][0]!==""){blank=false};};return rowNum};var _default=QueryBuilder;exports.default=_default;